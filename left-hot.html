<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì—ë„ˆì§€ ë¶„í¬ ì‹œë®¬ë ˆì´ì…˜</title>
  <style>
    :root {
      --bg:#0f1220; --panel:#171a2b; --text:#e6e8ef; --muted:#9aa0b4; --accent:#78a8ff;
      --red:#ef4444; --blue:#3b82f6; --purple:#a855f7; --yellow:#ffd166; --green:#51d19a;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background:var(--bg); color:var(--text)}
    .wrap{max-width:1100px; margin:24px auto; padding:0 16px}
    h1{font-size:20px; margin:0 0 8px; letter-spacing:.2px}
    .sub{color:var(--muted); margin-bottom:16px}
    .grid{display:grid; grid-template-columns:1.25fr .75fr; gap:16px}
    .card{background:var(--panel); border-radius:16px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .row>*{margin:4px 0}
    button{background:#222742; color:var(--text); border:1px solid #30365c; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600}
    button:hover{background:#283059}
    .pill{padding:6px 10px; border-radius:999px; background:#1e2444; border:1px solid #2a315e; font-size:12px}
    .legend{display:flex; align-items:center; gap:8px}
    .dot{width:10px; height:10px; border-radius:50%; display:inline-block}
    .stat{font-variant-numeric:tabular-nums; font-weight:600}
    canvas{display:block; width:100%; height:auto; border-radius:12px; background:#0b0e1a}
    .small{font-size:12px; color:var(--muted)}
    .side{display:grid; grid-template-rows:auto auto 1fr; gap:12px}
    .meterWrap{background:#0b0e1a; border:1px solid #283059; border-radius:12px; height:10px; overflow:hidden}
    .meterBar{height:100%; width:0%; background:linear-gradient(90deg, var(--green), var(--yellow))}
    .sep{height:1px; background:#2a315e; margin:12px 0}
  </style>
</head>
<body>
<div class="wrap">
  <div style="margin-bottom:8px"><a href="index.html#page-sim" style="color:#9aa0b4; text-decoration:none; border:1px solid #2a315e; padding:6px 10px; border-radius:8px">â† ê°¤ëŸ¬ë¦¬ë¡œ</a></div>
  <h1>ì—ë„ˆì§€ ë¶„í¬ ì‹œë®¬ë ˆì´ì…˜</h1>
  <div class="sub">ë‘ êµ¬íšì˜ ì…ìë“¤ì´ ì¤‘ì•™ì˜ ë¬¸ì„ í†µí•´ ì„ì´ë©° ì—ë„ˆì§€ê°€ í¼ì ¸ í‰ê·  ì—ë„ˆì§€ê°€ ê°™ì•„ì§€ê³ , ìƒ‰ì€ ëœ¨ê±°ì›€=ë¹¨ê°•, ì°¨ê°€ì›€=íŒŒë‘, ì¤‘ê°„=ë³´ë¼ë¡œ í‘œì‹œë˜ë©° í‰í˜•ì—ì„œ ë³´ë¼ìƒ‰ìœ¼ë¡œ ìˆ˜ë ´í•˜ê³  ì—”íŠ¸ë¡œí”¼ê°€ ìµœëŒ€ê°€ ëœë‹¤.</div>

  <div class="grid">
    <div class="card">
      <canvas id="sim" width="900" height="420"></canvas>
      <div class="row" style="justify-content:space-between; margin-top:10px">
        <div class="row">
          <span class="legend"><span class="dot" style="background:var(--red)"></span>ì™¼ìª½ ë¹¨ê°•: <span id="rLeft" class="stat">0</span>L / <span id="rRight" class="stat">0</span>R</span>
          <span class="legend" style="margin-left:12px"><span class="dot" style="background:var(--blue)"></span>ì˜¤ë¥¸ìª½ íŒŒë‘: <span id="bLeft" class="stat">0</span>L / <span id="bRight" class="stat">0</span>R</span>
          <span class="pill">ë¬¸ ë†’ì´: <span id="gatePerc">40</span>%</span>
        </div>
        <div class="row">
          <button id="toggle">â¯ï¸ ì¼ì‹œì •ì§€</button>
          <button id="reset">ğŸ”„ ë¦¬ì…‹</button>
        </div>
      </div>
    </div>

    <div class="side">
      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div>
            <div class="small">ì—”íŠ¸ë¡œí”¼ S(t) / S<sub>max</sub> (ê°’ë§Œ í‘œì‹œ)</div>
            <div class="meterWrap"><div id="meter" class="meterBar"></div></div>
          </div>
          <div class="stat">S: <span id="Snow">0.000</span></div>
        </div>
        <div class="sep"></div>
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <span class="pill">T<sub>L</sub>: <span id="TL">0.000</span></span>
            <span class="pill">T<sub>R</sub>: <span id="TR">0.000</span></span>
          </div>
        </div>
        <div class="sep"></div>
        <canvas id="chart" width="480" height="230"></canvas>
        <div class="small">ê·¸ë˜í”„: ì‹œê°„ì— ë”°ë¥¸ <b>í‰ê·  ì—ë„ˆì§€</b> (ì™¼ìª½=ë¹¨ê°• ì„ , ì˜¤ë¥¸ìª½=íŒŒë‘ ì„ ). ë‘ ì„ ì´ ë§Œë‚˜ê³  Sê°€ ìµœëŒ€ì— ê°€ê¹Œì›Œì§€ë©´ í‰í˜•.</div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <label>ì…ì(ê° ìƒ‰)</label>
            <input id="nInput" type="range" min="20" max="200" step="10" value="80" />
            <span class="stat" id="nLabel">80</span>
          </div>
          <div class="row">
            <label>ì†ë„ ë°°ìœ¨</label>
            <input id="vInput" type="range" min="0.4" max="3.0" step="0.1" value="1.3" />
            <span class="stat" id="vLabel">1.3</span>
          </div>
        </div>
        <div class="row" style="justify-content:space-between; margin-top:8px">
          <div class="row">
            <label>ë¬¸ ë†’ì´(%)</label>
            <input id="gInput" type="range" min="0" max="100" step="5" value="40" />
            <span class="stat" id="gateLabel">40%</span>
          </div>
          <div class="row">
            <label>ë¬¸ í­</label>
            <input id="gwInput" type="range" min="4" max="20" step="1" value="8" />
            <span class="stat" id="gwLabel">8px</span>
          </div>
        </div>
        <div class="small" style="margin-top:6px">ë¬¸ì´ ì‘ì„ìˆ˜ë¡(ê°œêµ¬ìœ¨â†“) í™•ì‚°ì´ ëŠë ¤ì§‘ë‹ˆë‹¤ â†’ ì—”íŠ¸ë¡œí”¼ ì¦ê°€ê°€ ì²œì²œíˆ ì§„í–‰ë©ë‹ˆë‹¤.</div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  function buildLogFact(maxN){const lf=new Float64Array(maxN+1); lf[0]=0; for(let i=1;i<=maxN;i++) lf[i]=lf[i-1]+Math.log(i); return lf;}
  function lnChoose(n,k,lf){if(k<0||k>n) return -Infinity; return lf[n]-lf[k]-lf[n-k];}
  const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));

  const sim=document.getElementById('sim'); const ctx=sim.getContext('2d');
  const chart=document.getElementById('chart'); const cctx=chart.getContext('2d');
  const W=sim.width, H=sim.height, midX=W/2; const radius=3.2;

  const TLspan=document.getElementById('TL'); const TRspan=document.getElementById('TR');
  const Sspan=document.getElementById('Snow'); const meter=document.getElementById('meter');
  const rL=document.getElementById('rLeft'), rR=document.getElementById('rRight');
  const bL=document.getElementById('bLeft'), bR=document.getElementById('bRight');

  const nInput=document.getElementById('nInput'), vInput=document.getElementById('vInput');
  const gInput=document.getElementById('gInput'), gwInput=document.getElementById('gwInput');
  const nLabel=document.getElementById('nLabel');
  const gateLabel=document.getElementById('gateLabel'); const gwLabel=document.getElementById('gwLabel');

  const toggleBtn=document.getElementById('toggle'); const resetBtn=document.getElementById('reset');

  toggleBtn.addEventListener('click', ()=>{ running=!running; });
  resetBtn.addEventListener('click', resetAll);
  nInput.addEventListener('input', (e)=>{ NperColor=+e.target.value; nLabel.textContent=NperColor; resetAll(); });
  vInput.addEventListener('input', (e)=>{ speedScale=+e.target.value; document.getElementById('vLabel').textContent=speedScale.toFixed(1); });
  gInput.addEventListener('input', (e)=>{ gatePct=+e.target.value; document.getElementById('gatePerc').textContent=gatePct; gateLabel.textContent=gatePct+'%'; });
  gwInput.addEventListener('input', (e)=>{ gateWidth=+e.target.value; gwLabel.textContent=gateWidth+'px'; });

  let gatePct=40, gateWidth=8, speedScale=1.3, NperColor=80, running=true;
  let particles=[]; let logFact=buildLogFact(20000); let maxLogW=0;
  let history=[]; let t=0; let last=performance.now();

  function makeParticle(isRed){
    let x,y; if(isRed){ x=Math.random()*(midX-2*radius)+radius; } else { x=Math.random()*(midX-2*radius)+midX+radius; }
    y=Math.random()*(H-2*radius)+radius;
    // left hot, right cold fixed anchors (T=6.0 vs 0.2)
    const vMag = (isRed ? Math.sqrt(2*6.0) : Math.sqrt(2*0.2));
    const th=Math.random()*Math.PI*2;
    const vx=vMag*Math.cos(th), vy=vMag*Math.sin(th);
    return {x,y,vx,vy,red:isRed};
  }

  function initParticles(){
    particles=[];
    for(let i=0;i<NperColor;i++) particles.push(makeParticle(true));
    for(let i=0;i<NperColor;i++) particles.push(makeParticle(false));
    const lnWmaxRed=lnChoose(NperColor, Math.floor(NperColor/2), logFact);
    const lnWmaxBlue=lnChoose(NperColor, Math.floor(NperColor/2), logFact);
    maxLogW=lnWmaxRed+lnWmaxBlue; history=[]; t=0;
  }

  function measure(){
    let rLcount=0,bLcount=0,leftCount=0,rightCount=0,sumKEL=0,sumKER=0;
    for(const p of particles){
      const left=p.x<midX; const KE=0.5*(p.vx*p.vx+p.vy*p.vy);
      if(left){leftCount++; sumKEL+=KE; if(p.red) rLcount++; else bLcount++;}
      else {rightCount++; sumKER+=KE;}
    }
    const rRcount=NperColor-rLcount, bRcount=NperColor-bLcount;
    rL.textContent=rLcount; rR.textContent=rRcount; bL.textContent=bLcount; bR.textContent=bRcount;
    const lnW=lnChoose(NperColor, rLcount, logFact)+lnChoose(NperColor, bLcount, logFact);
    const S=Math.max(0, lnW), Smax=maxLogW; const Snorm=Math.max(0, Math.min(1, S/Smax));
    Sspan.textContent=Snorm.toFixed(3); meter.style.width=(Snorm*100).toFixed(1)+'%';
    const TL=leftCount? (sumKEL/leftCount):0, TR=rightCount? (sumKER/rightCount):0;
    TLspan.textContent=TL.toFixed(3); TRspan.textContent=TR.toFixed(3);
    return {Snorm, TL, TR};
  }

  function step(dt){
    const openHalf=(gatePct/100)*(H/2); const gateTop=H/2-openHalf, gateBot=H/2+openHalf; const halfW=gateWidth/2;
    for(const p of particles){
      p.x+=p.vx*speedScale*dt; p.y+=p.vy*speedScale*dt;
      if(p.y<radius){ p.y=radius; p.vy*=-1; }
      else if(p.y>H-radius){ p.y=H-radius; p.vy*=-1; }
      if(p.x<radius){ p.x=radius; p.vx*=-1; }
      else if(p.x>W-radius){ p.x=W-radius; p.vx*=-1; }
      const nearWall=Math.abs(p.x-midX)<= (halfW+radius); const withinGate=(p.y>=gateTop && p.y<=gateBot);
      if(nearWall && !withinGate){ if(p.x<midX){ p.x=midX-(halfW+radius); } else { p.x=midX+(halfW+radius); } p.vx*=-1; }
    }
  }

  const BLUE=[59,130,246], RED=[239,68,68];
  const T_BLUE=0.2, T_RED=6.0;
  const lerp=(a,b,u)=>Math.round(a+(b-a)*u);
  const mixRGB=(u)=>`rgb(${lerp(BLUE[0],RED[0],u)},${lerp(BLUE[1],RED[1],u)},${lerp(BLUE[2],RED[2],u)})`;
  function keToU(KE){ let t=(KE - T_BLUE)/Math.max(1e-9, (T_RED - T_BLUE)); t = Math.max(0, Math.min(1, t)); return Math.pow(t, 0.9); }
  function tintedU(u, TL, TR){ const delta=Math.abs(TL-TR); const contrast=Math.max(0, Math.min(1, delta/Math.max(1e-9, (T_RED-T_BLUE)))); return 0.5 + (u-0.5)*contrast; }

  function draw(TL, TR){
    ctx.clearRect(0,0,W,H); ctx.fillStyle='#0b0e1a'; ctx.fillRect(0,0,W,H);
    const openHalf=(gatePct/100)*(H/2); const gateTop=H/2-openHalf, gateBot=H/2+openHalf; const halfW=gateWidth/2;
    ctx.fillStyle='#263055'; ctx.fillRect(midX-halfW, 0, gateWidth, gateTop); ctx.fillRect(midX-halfW, gateBot, gateWidth, H-gateBot);
    const grad=ctx.createLinearGradient(midX-8,0,midX+8,0); grad.addColorStop(0,'rgba(120,168,255,0)'); grad.addColorStop(0.5,'rgba(120,168,255,0.22)'); grad.addColorStop(1,'rgba(120,168,255,0)'); ctx.fillStyle=grad; ctx.fillRect(midX-12, gateTop, 24, gateBot-gateTop);
    for(const p of particles){
      const KE=0.5*(p.vx*p.vx+p.vy*p.vy);
      const uRaw = keToU(KE);
      const uTint = tintedU(uRaw, TL, TR);
      ctx.beginPath(); ctx.arc(p.x,p.y, radius, 0, 2*Math.PI);
      ctx.fillStyle = mixRGB(uTint);
      ctx.fill();
    }
  }

  function drawChart(){
    const pad=28, w=chart.width, h=chart.height; cctx.clearRect(0,0,w,h);
    cctx.strokeStyle='#32406f'; cctx.lineWidth=1; cctx.beginPath(); cctx.moveTo(pad,h-pad); cctx.lineTo(w-pad,h-pad); cctx.moveTo(pad,h-pad); cctx.lineTo(pad,pad); cctx.stroke();
    if(history.length<2) return; const tMin=history[0][0], tMax=history[history.length-1][0];
    let yMax=0; for(const [,TL,TR] of history){ yMax=Math.max(yMax, TL, TR); } yMax=Math.max(1e-3, yMax*1.05);
    const xFor=tt=> pad + (tt-tMin)/Math.max(1e-6,(tMax-tMin))*(w-2*pad);
    const yFor=v=> (h-pad) - (v/yMax)*(h-2*pad);
    cctx.strokeStyle='rgba(154,160,180,0.12)';
    for(let g=0; g<=4; g++){ const y=yFor((yMax*g)/4); cctx.beginPath(); cctx.moveTo(pad,y); cctx.lineTo(w-pad,y); cctx.stroke(); }
    cctx.lineWidth=2; cctx.strokeStyle='rgb(239,68,68)'; cctx.beginPath(); cctx.moveTo(xFor(history[0][0]), yFor(history[0][1]));
    for(const [tt,TLv] of history.map(h=>[h[0],h[1]])){ cctx.lineTo(xFor(tt), yFor(TLv)); } cctx.stroke();
    cctx.lineWidth=2; cctx.strokeStyle='rgb(59,130,246)'; cctx.beginPath(); cctx.moveTo(xFor(history[0][0]), yFor(history[0][2]));
    for(const [tt,TRv] of history.map(h=>[h[0],h[2]])){ cctx.lineTo(xFor(tt), yFor(TRv)); } cctx.stroke();
    cctx.fillStyle='#9aa0b4'; cctx.font='12px ui-sans-serif';
    cctx.fillText('í‰ê·  ì—ë„ˆì§€ (ì™¼ìª½=ë¹¨ê°•, ì˜¤ë¥¸ìª½=íŒŒë‘)', pad, pad-8);
  }

  function loop(now){
    const dt=Math.min(0.033,(now-last)/16); last=now; if(running) step(dt);
    const {Snorm, TL, TR}=measure();
    if(history.length===0 || (t-history[history.length-1][0])>0.05){ history.push([t, TL, TR]); if(history.length>1200) history.shift(); }
    draw(TL, TR); drawChart(); if(running) t += dt*0.016*60; requestAnimationFrame(loop);
  }

  function resetAll(){
    initParticles();
    const m = measure();
    history = [[0, m.TL, m.TR]];
    draw(m.TL, m.TR);
    drawChart();
  }

  let gatePct=40, gateWidth=8, speedScale=1.3, NperColor=80, running=true;
  let logFact=buildLogFact(20000), maxLogW=0, particles=[], history=[], t=0, last=performance.now();
  resetAll();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
